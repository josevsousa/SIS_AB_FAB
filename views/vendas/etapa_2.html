{{extend 'dashboard.html'}}

<link rel="stylesheet" href="{{=URL('static','jquery-ui-1.11.4.custom/jquery-ui.css')}}">
<script src="{{=URL('static','jquery-ui-1.11.4.custom/jquery-ui.js')}}"></script>
<script>
  $(document).ready(function(){
  $('#codigo').focus();

      //=======================LISTA ITENS PRODUTO ================================
          //busca itens no db
          var lista_NomeCodigo = [
            {{for item in db(db.produtos.id>0).select('codigo_produto','nome_produto'):}}
             {codigo:"{{=item.codigo_produto}}",nome:"{{=item.nome_produto}}"},
            {{pass}}
          ];
          //-------------------------- popula codigo
          var listaCodigoProdutos = [];
          for(item in lista_NomeCodigo){
            listaCodigoProdutos.push( lista_NomeCodigo[item].codigo ) 
          }
          //autocomplete do codigo
          $( "#codigoo" ).autocomplete({
            source: listaCodigoProdutos,
            
            select: function( event, ui ) {
              //add nome ao input nome
              $("#qtde").attr('disabled',false).focus();
              var x = lista_NomeCodigo.filter(function(item){
                return item.codigo === ui.item.value;
              });
              //add ao campo nome
              $("#produto").val(x[0].nome);
            }
          }).on( "autocompletecreate", function( event, ui ) {} );

          $('#codigo').on('change',function(){
                      // $(this).addClass('codigoError').focus();

                      //seu valor digitado
                      var codDigitado = $(this).val();
                      //testa seu valor digitado
                      var buscaCodigo = lista_NomeCodigo.some(function(item){
                        return item.codigo === codDigitado; 
                      });  
                      if (buscaCodigo) {
                        $(this).removeClass('codigoError');
                        $("#qtde").attr('disabled',false).focus();
                        //busca o nome pelo codDigitado
                        var buscaNome = lista_NomeCodigo.filter(function(item){
                          return item.codigo === codDigitado;
                        });                       
                        $("#produto").val(buscaNome[0].nome).attr('disabled',false);


                      } else{
                        if (codDigitado == '') {
                          $("#produto").val('').attr('disabled',false).focus();
                          $('#codigo').removeClass('codigoError');
                        }else{
                          $('#codigo').addClass('codigoError').focus();
                          $("#produto, #qtde").val('').attr('disabled',true);
                        };
                      };

                                //   //add ao campo nome
                      //   $("#produto").val(x[0].nome);
          });



          //libera a tecla addItem
          $("#qtde").change(function(){
              $("#addItem").attr('disabled',false).focus();
              if ($(this).val() == '') {
                $("#addItem").attr('disabled',true)
              };
          })

          $("#addItem").on('click',function(){
            $(this).text("...").attr('disabled',true);
            ajax('produto',['codigo','qtde','produto']);
           // $(location).attr('href',"etapa_2?menu=caixa");//redireciona a pagina location.reload()
           location.reload()
          })
      //------------------------- fim popula codigo    
      
      //------------------------- popula produtos
      var listaNomeProdutos = [];
      for(item in lista_NomeCodigo){
        listaNomeProdutos.push( lista_NomeCodigo[item].nome ) 
      }
      //autocomplete do produto
      $( "#produto" ).autocomplete({
        source: listaNomeProdutos,
         select: function( event, ui ) {
          //add produto ao input produto
          $("#qtde").attr('disabled',false).focus();
          var x = lista_NomeCodigo.filter(function(item){
            return item.nome === ui.item.value;
          });
          //add ao campo produto
          $("#codigo").val(x[0].codigo)
        }
      }).on( "autocompletecreate", function( event, ui ) {} )
      //------------------------- fim popula produtos


      // botao deletar item
      // $(".JpositionDel .fechar").on('click',function(){
      //   $(this).parent().parent().parent().hide(400)
      // });
    //=======================LISTA ITENS================================
  
    // deleta item
    $(".del").on('click',function(){
        var c = confirm("Tem certeza que deseja cancelar a venda???")
        if (c == true) {
            cod = $(this).parent().parent().children()[0].textContent; 
            $('#transitory').val(cod); 
            ajax('delItem',['transitory']);
            $(location).attr('href',"etapa_2?menu=caixa");//redireciona a pagina
        }
    });
 

  });//fim do jquary.document
</script>


<style>
/*new logo*/
img#logo-new_theme{
    width: 101px !important;
    padding: 0px 6px !important;
    font-size: 18px !important; 
}
.sidebar .logo, .sidebar[data-background-color="white"] .logo, .off-canvas-sidebar .logo, .off-canvas-sidebar[data-background-color="white"] .logo {
    border-bottom: 1px solid rgba(102, 97, 91, 0.3);
    display: -webkit-box;
    margin: 0 auto;
    text-align: -webkit-center;
}
/*fim new logo*/
h3.tit_hist {
    padding-left: 14px;
}
/*=======================*/
 /*-- thema form_etapa*/
  .codigoError{color: red;} 
  .codigoError:focus {
    border-color: red;
    outline: 0;
    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(233, 102, 138, 0.6);
    box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(233, 102, 162, 0.6);
  }

.row.addItem input {
    /*background: white;*/
    border: 1px solid #E0DDD2;
}

.row.addItem {
    margin: 21px 0px 10px 0px;
}
 .contage{
    font-size: x-large;
    border-radius: 22px;
    background: #cccccc;
  }
  .contageP {
    font-size: 12px;
    border-radius: 22px;
    background: #E6E67C;
  }
  .cor_Contage_ok{ 
    background: #2DEC2A !important;
  }
  .cor_Contage_Edit{ 
    background: #FFBC00 !important;
  }
  .fluxoVenda{
    width: 143px;
    float: left;
    margin: 9px 20px;
  }
  .row blockquote{
    float: left; 
  }
  .row_borda_bottom{
    border-bottom: 1px solid #E8E8E8;
  }
  .col-md-4{
     padding: 11px 0px;
  }

  a, a:link, a:hover {
    text-decoration: none;
  }
.vermelhoAlert{
  color: #FF1100 !important;
}
.trIni{
      background: #FFF8B9 !important;
}
#minhaTabelaNew tbody{
    border-bottom: 1px solid #CCC5B9 !important;
}
a.btn.btn-danger.del.btn-xs {
    border: none;
}
.table-responsive.table-full-width {
    display: inline;
}
span#totalDestaque{
  color: #2AC130 !important;
}
  /*--grid--*/
}
/*  #minhaTabela thead tr th:nth-child(6), #minhaTabela tbody tr td:nth-child(6){
    width: 45px !important;  }
  #minhaTabela thead tr th:nth-child(5), #minhaTabela tbody tr td:nth-child(5){
    width: 115px !important;  }
  #minhaTabela thead tr th:nth-child(4), #minhaTabela tbody tr td:nth-child(4){
    width: 115px !important;  }
  #minhaTabela thead tr th:nth-child(1), #minhaTabela tbody tr td:nth-child(1){
    width: 75px !important;  }
  #minhaTabela thead tr th:nth-child(2), #minhaTabela tbody tr td:nth-child(2){
    width: 50px !important;  }*/
  
  /*--fim grid--*/

  .addItem{padding: 17px;}
  .addItem input, .addItem button{ 
    float:left;margin-left: 3px;
    margin: 0px 3px 2px 2px;
  }
  #codigo{
    width: 15%;
  }
  #qtde{
    width: 15%;
  }
  #produto{
    width: 58%;
  }
  .highlight{
    padding: 16px 15px 22px 16px;
  }
  .highlight a{
    width: 100%;
  }
  .highlight a:hover{
        background: #FDFDFD;
    border-color: #E1E1E8;
  }
  .highlight div.t{
    padding: 9px 14px;
    margin-bottom: 2px;
    background-color: #f7f7f9;
    border: 1px solid #e1e1e8;
    border-radius: 4px;
    width: 100%;
    float: left;
    font-size: 19px;
    text-align: center;
  }
  .btCC{
    width: 9%;
  }
  #proximo {
    color: #FFFFFF;
    background-color: #67D296;
    opacity: 1;
    font-weight: bold;
    font-size: large;
  }
  .card{padding: 8px !important;}
</style>

<input type="text" id="transitory" name="transitory" style="display:none">
<div class="wrapper">
    <div class="sidebar" data-background-color="white" data-active-color="danger">
        <div class="sidebar-wrapper">
            <div class="logo">
                <a href="http://www.creative-tim.com" class="simple-text">
                    {{=response.logo.new_theme}}
                </a>
            </div>
            {{=response.barraL}}
        </div>
    </div>
    <div class="main-panel">
        <div id="aviso" style='display:none' class="alert alert-warning alert-with-icon" data-notify="container"></div>
        <nav class="navbar navbar-default">
            <div class="container-fluid">

                <div class="navbar-header">
                    <button type="button" class="navbar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar bar1"></span>
                        <span class="icon-bar bar2"></span>
                        <span class="icon-bar bar3"></span>
                    </button>
                    
                    <h3 class="tit_hist">Caixa
<a type="text" id="caixa" href="historico" class="btn btn-success">Hist√≥rico</a></h3>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <!--  <li class="dropdown">
                              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                    <i class="ti-bell"></i>
                                    <p class="notification">5</p>
                                    <p>Alertas</p>
                                    <b class="caret"></b>
                              </a>
                              <ul class="dropdown-menu">
                                <li><a href="#">Notification 1</a></li>
                                <li><a href="#">Notification 2</a></li>
                                <li><a href="#">Notification 3</a></li>
                                <li><a href="#">Notification 4</a></li>
                                <li><a href="#">Another notification</a></li>
                              </ul>
                        </li> -->
                        <!-- <li>
                            <a href="#">
                                <i class="ti-settings"></i>
                                <p>Settings</p>
                            </a>
                        </li> -->
                    </ul>

                </div>
            </div>
        </nav>

        <div class="content">
            <div class="container-fluid">

<!-- ==================================================================== -->
  <div class="row row_borda_bottom"> 
    <div class="fluxoVenda">
    <a href="etapa_1">
      <span class="label contage cor_Contage_ok">1</span>
    </a>
    <span class="label contage cor_Contage_Edit">2</span>
    <a href="etapa_3">    
      <span class="label contage">3</span>
    </a>
    </div>
    <blockquote>
      <p class="lead">Voc√™ esta no (2) de (3) {{=XML(" | Cod: <kbd>%s</kbd>"%session.codigo_venda)}}</p>
    </blockquote>
    <a type="button" href="etapa_3" id="proximo" class="btn btn-success btn-fill btn-lg">Fechar caixa</a>
        
  </div>
  <div class="row">
    <div class='col-md-12'>
           <!-- row -->
        <div class="row addItem">
           <input class="form-control ui-autocomplete-input" id="codigo" name="codigo" type="number" placeholder="codigo" autocomplete="off">
           <input class="form-control" id="qtde" name="qtde" type="number" placeholder="qtde" disabled="disabled" autocomplete="off">
           <input class="form-control  ui-autocomplete-input" id="produto" name="produto" type="text" placeholder="Produto" autocomplete="off">
           <button type="button" id="addItem" class="btn btn-info btn-fill" disabled="disabled">+</button>
           
          <!-- <a href="etapa_3?menu=caixa" class="btn btn-fill btn-success" type="submit" id="proximo" value="Pr√≥ximo">Fechar Caixa</a> -->
           
        </div> 
    </div>
    </div>
  </div>
  <div class="row ">
        <div class="col-md-12" id='grid'>
        <div class="card">
                            <div class="header">
                                <h4 class="title">Total: <span id='totalDestaque'>{{=double_real(sTotal).real()}}</span></h4>
                                <!-- <p class="category">Here is a subtitle for this table</p> -->
                            </div>
                               
 <table id="minhaTabelaNew" class="table table-striped hover " cellspacing="0" width="100%" >
              <thead>
                <tr>
                  <th style='display:none'>-</th>
                  <th style='display:none'>-</th>
                  <th class='btCC'>Codigo</th>
                  <th class='btCC'>Qtde</th>
                  <th>Produto</th>
                  <th>Valor Unid</th>
                  <th>Valor Total</th>
                  <th></th>
                </tr> 
                </thead>
                <tbody>
                  {{for iten in grid:}}
                      <tr>
                        <td style='display:none'>{{="%s"%iten.id}}</td>
                        <td style='display:none'>{{="%s"%iten.dataRegistro}}</td>
                        <td class='btCC'>{{=iten.codigoIten}}</td>
                        <td class='btCC'>{{=iten.quantidade}}</td>
                        <td>{{=iten.produto}}</td>
                        {{valor = double_real(float(iten.valorUnidade)).real()}}
                        {{if valor == 'R$ 0,00':}}
                          <td class="vermelhoAlert">{{=valor}}</td>
                        {{else:}}
                          <td>{{=valor}}</td>
                        {{pass}}


                        <td>{{=double_real(float(iten.valorTotal)).real()}}</td>
                        
                        <td class="btDD">
                        <a class="btn btn-danger del btn-xs" href="#"><i class="ti-close"></i></span></a></td>
                      </tr>
                  {{pass}}  
                </tbody>
  
              </table>  
                        </div>
    </div>
  </div>

 
<!-- ==================================================================== -->
            </div>
        </div>

        <footer class="footer">
            <div class="container-fluid">
                <nav class="pull-left">
                    <ul>

                        <li>
                            <a href="http://www.creative-tim.com">
                                Creative Tim
                            </a>
                        </li>
                        <li>
                            <a href="http://blog.creative-tim.com">
                               Blog
                            </a>
                        </li>
                        <li>
                            <a href="http://www.creative-tim.com/license">
                                Licenses
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="copyright pull-right">
                    &copy; <script>document.write(new Date().getFullYear())</script>, made with <i class="fa fa-heart heart"></i> by <a href="http://www.creative-tim.com">Creative Tim</a>
                </div>
            </div>
        </footer>


    </div>
</div>